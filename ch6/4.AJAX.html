<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4.AJAX</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            //user1 요청 실습
            const btnUser1 = document.getElementById('btnUser1');
            const pUser1 = document.getElementById('user1');
            const spanUser1s = pUser1.getElementsByTagName('span');

            btnUser1.addEventListener('click',function() {
                //AJAX 객체 생성 및 요청
                const xhr = new XMLHttpRequest();
                xhr.open('GET','./data/user1.json');
                xhr.send();

                //응답 처리
                xhr.onreadystatechange = function() {
                    //응답완료
                    if(xhr.readyState == XMLHttpRequest.DONE) {
                        //요청 성공 확인
                        if(xhr.status == 200) {
                            //JSON 문자열 객체 변환
                            const json = JSON.parse(xhr.responseText);

                            //화면 출력
                            spanUser1s[0].innerText = json.uid;
                            spanUser1s[1].innerText = json.name;
                            spanUser1s[2].innerText = json.age;
                            spanUser1s[3].innerText = json.addr;
                        }
                    }
                };
            }); //btnUser1.addEventListener 끝

            //user2 요청 실습
            const btnUser2 = document.getElementById('btnUser2');
            const pUser2 = document.getElementById('user2');
            const spanUser2s = document.querySelectorAll('#user2 > span');

            btnUser2.addEventListener('click', function() {
                fetch('./data/user2.json')
                .then(response => response.json())
                .then(data => {
                    console.log(data);

                    spanUser2s[0].innerText = data.uid;
                    spanUser2s[1].innerText = data.name;
                    spanUser2s[2].innerText = data.age;
                    spanUser2s[3].innerText = data.addr;
                })
                .catch(err => {
                    //통신 에러 발생시 
                    console.log(err);
                });
            });

            //user2 요청 실습
            const btnUsers = document.getElementById('btnUsers');
            const tableUsers = document.getElementsByTagName('table')[0];

            btnUsers.addEventListener('click',async function() {
                //await를 호출하는 상위 함수는 반드시 async 선언
                const response = await fetch('http://192.168.0.197:5500/ch6/data/users.json');
                const jsonData = await response.json();

                tableUsers.insertAdjacentHTML('beforeBegin',`<p>${jsonData.title}</p>`);

                for(const user of jsonData.users) {
                    //태그 문자열 생성
                    const trStr = 
                        `<tr>
                            <td>${user.uid}</td>    
                            <td>${user.name}</td>    
                            <td>${user.age}</td>    
                            <td>${user.addr}</td>    
                        </tr>`;

                    //태그 문자열 삽입
                    tableUsers.insertAdjacentHTML('beforeend',trStr);
                }
            });
        });//DOMContentLoaded 끝
    </script>
</head>
<body>
    <h3>4.AJAX(비동기 HTTP 통신)</h3>

    <button id="btnUser1">user1 요청</button>
    <p id="user1">
        아이디: <span></span><br>
        이름: <span></span><br>
        나이: <span></span><br>
        주소: <span></span><br>
    </p>

    <button id="btnUser2">user2 요청</button>
    <p id="user2">
        아이디: <span></span><br>
        이름: <span></span><br>
        나이: <span></span><br>
        주소: <span></span><br>
    </p>

    <button id="btnUsers">users 요청</button>
    <table border="1">
        <tr>
            <th>아이디</th>
            <th>이름</th>
            <th>나이</th>
            <th>주소</th>
        </tr>
    </table>
</body>
</html>